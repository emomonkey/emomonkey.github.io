<!DOCTYPE html>
<html>
  <head>
      <meta charset="utf-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
      <title>Stephen's Blog - Effective Use of Concurrent Sidekiq Workers</title>
      <meta name="viewport" content="width=device-width">

      <!-- syntax highlighting CSS -->
      <link rel="stylesheet" href="/stylesheets/syntax.css">

      <!-- Custom CSS -->
      <link rel="stylesheet" href="/stylesheets/main.css">

      <!-- Responsive CSS -->
      <link rel="stylesheet" href="/stylesheets/responsive.css">

      <!-- Google Fonts -->
      <link href='http://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,700' rel='stylesheet' type='text/css'>
      <link href='http://fonts.googleapis.com/css?family=Raleway:300,400,700' rel='stylesheet' type='text/css'>
      <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
      <script src="javascripts/respond.js"></script>
      <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
      <![endif]-->
      <!-- [if lt IE 8]>
      <link rel="stylesheet" href="stylesheets/ie.css">
      <![endif]-->
       
       <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  </head>
  <body>
    <div class="site">
      <div class="sidebar" id="sidebar">
        <div class="header">
          <h1 class="title"><a href="/"><img id="logo" src="http://emomonkey.github.io/images/portrait.jpg"></a></h1>
          <span class="tagline">Personal Blog</span>
          <span class="tagline"><a href="/nasa" >NASA page</a></span>
        </div>
        <div class="posts">
          <ul class="posts-list">
            
          </ul>
          
          <div class="pagination">
            
              <span class="previous">Previous</span>
            
            <span class="page_number ">
              Page:  of 
            </span>
            
              <span class="next ">Next</span>
            
          </div>

        </div>
      </div> 
       <body>
        <div class="content" id="home">
        <div id="sidebar-button">
          <img src="/images/sidebar-button.png">
        </div>
        <div id="post-info">
         
          <div id="info-container">
            <h1 id="title">Effective Use of Concurrent Sidekiq Workers</h1>
            <span id="date">11 Feb 2015</span>
          </div>
        </div>
      
        <div class="post">
          <p>One of the benefits of Sidekiq is that it allows your application to work on a single task using simultaneous worker processes which also  means that you have a set of additional problems</p>
<ul>
<li>Ensure separate workers do not save the same record result at the same causing data duplication</li>
<li>Ensure separate workers do not work on the same data</li>
</ul>
<p>Sidekiq has proved useful on my web scraping code for my Northern Ireland Property Web Site at <a href="http://www.propertytrackerni.co.uk/">http://www.propertytrackerni.co.uk</a></p>
<p>Obviously neither of these issues is something that you would want to happen in your working application and the issue if data duplication can be easily resolved by adding unique database constraints so that the same data cannot be added to your database table.</p>
<p>The second issue can be resolved by marking off data that has been processed already which I have achieved by adding the below line to the code</p>
<blockquote><p>  if pdate == nil or (pdate.year &lt;= Time.now.year and pdate.mon != Time.now.month)</p></blockquote>
<p>This pdate contains the date the search area record was last processed and as this task is monthly this means search areas that have already been processed will be passed over. Now this does mean that later workers will have to iterate over search params that have already been processed but as the number of search areas can be measured in the thousands (Northern Ireland is quote small) this is not much overhead. The WHERE ActiveRecord statement could be used on top of the top condition e.g.</p>
<blockquote><p>SearchParams.where(“searchdate is null or (EXTRACT(YEAR FROM searchdate) &lt;= EXTRACT(YEAR FROM now()) AND EXTRACT(MONTH FROM searchdate) &lt;= EXTRACT(MONTH FROM now()))find_each(start:isize, batch_size: batchsize)</p></blockquote>
<p>However as find_each retrieves data in batches it is possible another worker could have retrieved one of your batches and it is now processed so the if condition is needed as well as the database constraint. The database constraint is needed as it is possible that the more than one worker could have grabbed the row before a database update has been done.</p>
<p>I would be interested in hearing about better methods that could be used to achieve this using SideKiq and Ruby. For example can I specify the number of workers dynamically and then calculate how the records to be processed are split among the workers. This does not seem the case in sidekiq.yml. I know I can specify the maximum number of workers but that is it</p>
<blockquote><p>:verbose: false<br />
:pidfile: ./tmp/pids/sidekiq.pid<br />
:logfile: ./log/sidekiq.log<br />
:concurrency: 25<br />
:queues:<br />
- default<br />
- queue_analysis<br />
- queue_scraper<br />
:limits:<br />
queue_analysis: 1<br />
queue_scraper: 15</p></blockquote>
<p>The code is below</p>
<blockquote><p>class ParseResultsWorker</p>
<p>include Sidekiq::Worker</p>
<p>sidekiq_options :queue =&gt; :queue_scraper</p>
<p>def perform(*args)<br />
isize = 1<br />
batchsize = 10000<br />
stime = Time.now<br />
vst = stime.strftime("%H:%M:%S");<br />
tstat = Transstatus.find_by name: 'ParseResultsWorker', created_at: Time.now.utc.to_date<br />
if tstat.nil?<br />
tstat = Transstatus.create(:name =&gt; "ParseResultsWorker" )<br />
end<br />
Rails.logger.debug ' ParseResultsWorker start job ' + vst<br />
SearchParams.find_each(start:isize, batch_size: batchsize) do |params|<br />
pdate = params['searchdate']<br />
if pdate == nil or (pdate.year &lt;= Time.now.year and pdate.mon != Time.now.month)<br />
tstat.update(currentparam: params.searchparam)<br />
@pnewscrawl = PropertyNewsCrawler.new('http://www.propertynews.com', params.searchparam)<br />
@pnewscrawl.findresult<br />
end<br />
end<br />
etime = Time.now<br />
vet = etime.strftime("%H:%M:%S");<br />
PropertySite.lastscanned<br />
Rails.logger.debug ' ParseResultsWorker end job ' + vet<br />
rescue StandardError =&gt; e<br />
Rails.logger.debug 'Error running ParseResultsWorker.perform ' + e.message<br />
return false;<br />
end<br />
end</p></blockquote>

        </div>
        <div class="colophon">
          <p>
            <span id="pub-date">Published on 11 Feb 2015</span> <span class="separator">&bull;</span>
            <span id="social">Find me on <a href="">Twitter</a>!</span>
          </p>
        </div>
      </div>
       </body>
     
       
        <div class="footer">
          <span id="footer-links">
                <a href="http://emomonkey.github.io" class="footer-link">Home</a><span class="separator">&bull;</span>
                <a href="https://github.com/emomonkey" class="footer-link">View On GitHub</a><span class="separator">&bull;</span>
                <a href="https://uk.linkedin.com/pub/stephen-emo/60/308/54b" class="footer-link">LinkedIn</a><span class="separator">&bull;</span>
          </span>
          <div class="google-ads">
                <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
                <!-- Programming Blog Ads -->
                 <ins class="adsbygoogle"
                      style="display:block"
                      data-ad-client="ca-pub-9203088421896530"
                      data-ad-slot="3590526208"
                      data-ad-format="auto"></ins>
                <script>
                (adsbygoogle = window.adsbygoogle || []).push({});
                    </script>
                </div>
        </div>

        
      </div>

        

    </div>
    <script src="/javascripts/responsive.js" type="text/javascript"></script>
    <script type="text/javascript">
        var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
        document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
      </script>
      <script type="text/javascript">
        try {
          var pageTracker = _gat._getTracker("UA-97629936-1");
        pageTracker._trackPageview();
        } catch(err) {}
</script>
  </body>
</html>
